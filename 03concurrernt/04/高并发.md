# 请思考: 什么是并发? 什么是高并发? 实现高并发高可用系统需要考虑哪些 因素，对于这些你是怎么理解的?

## 什么是并发? 什么是高并发?
并发依照我的理解就是指我们系统能同时处理多个任务的能力，高并发从字面上来理解就是让单位时间同时处理任务的能力尽可能的高。也就是说：
我们所开发的系统，要在短时间能能支持大量访问请求的情况。  
作为衡量我们系统是否达到了高并发的要求，我们可以衡量以下指标：
1. 响应时间
2. 吞吐量
3. 并发数，并发用户数

做为高并发系统，需要实现的目标为：
高性能、高可用性、高扩展性

## 高性能
### 持久层的性能考虑
在一个高并发系统中，持久层往往是我们性能的瓶颈，因此需要对其选型进行细致的考量。
对持久层的选型主要考虑以下几个方面：  
1. 数据量级：如几万数据量级可以选择单库，几十到几百万可以选择分库分表，几亿可以选择hbase等列族数据库
2. 性能：一般又分为读性能和写性能，如mongodb等读性能较强，hbase等写性能较强
3. 可扩展性：如单机oracle可扩展性不强，不可水平扩展，随着数据量增大，扩展的代价较大，反之cassandra可水平扩展
4. 灵活性：如关系型数据库有结构化的表定义，后期不太方便更改，但是对事务支持较好，nosql则随业务更改表结构十分方便
5. 成本：如全内存方案虽然大大提升了性能，但是成本比较高  

另外，我们在考虑持久层性能瓶颈的时候，还要注意以下几个方面：
1. 正确使用索引
2. 查找慢查询原因
3. 锁与事务的正确使用

另外还要考虑持久性的可用性，与数据丢失时的恢复方案，以及安全性问题考虑（如sql注入攻击）

### 服务层的性能考虑
服务层的性能，我认为首先也是要考虑一个可扩展性。  
可以尽量将我们的服务设计为幂等的，这样便可实现对服务节点的水平扩展。  
如果我们的服务层可以水平扩展，那么并发量的增加便可通过增加资源来解决，优化单机的性能反而变成了锦上添花的存在。  
这时，如何协调不同的并发节点就成为了系统的重中之重，也就是可用性方面的考虑就重要了许多。  
否则，我们就需要想尽一切办法优化单机的性能。  
从我的经验来说，我觉得从整体层面可以从以下方面考虑：
1. 网络拓扑，用户请求过来，到响应，链条有多长
2. 微服务粒度的合理划分
3. 选用不同的接口框架的性能差异，如dubbo等rpc框架可以把数据压缩得比较小，但是需要强依赖相关jar包，spring cloud提供restful的http接口，但是传输效率比rpc较低
4. 路由、熔断、监控、故障自动恢复等，主要是可用性方面的考虑
5. 充分考虑分布式系统下的一致性问题，如配置中心，分布式锁，分布式事务等，保障高并发读写下的数据一致性
6. 兼容不同语言开发的系统，整套系统方案修改和升级的代价，服务是跑在物理机，虚机还是云原生等扩展性和运维方面的考虑

从个体层面可以从以下方面考虑：
1. 服务是计算密集型的还是IO密集型的？如果是CPU密集型，就尽量提高CPU使用的效率，合理使用多线程技术，充分利用多核CPU的优势，如果是IO密集型，就尽量提高IO吞吐和线程切换的效率，如使用IO多路复用和零拷贝技术
2. 内存使用上，尽量避免使用Swap，如果对性能要求特别高，则可以使用全内存的方案，但是由于内存断电后会清零，要充分考虑异常中断时如何恢复的问题，如果内存比较富裕，可以考虑多使用内存缓存缓存一部分数据，提高读取效率，如果使用java，可以使用与jvm堆容量匹配的GC算法提高GC效率，降低延时
3. 磁盘使用上，可以根据情况，选用云盘，物理磁盘，SSD等不同种类的磁盘，写日志尽量以异步的方式记录，同时可以利用RAID等技术提升磁盘的可靠度


### 常用的高可用框架
1. DNS 负载均衡 能将流量负载到多个机房
2. F5 或者nginx的负载均衡 在机房的入口对流量进行再次的分流
3. 服务无状态设计 springcloud微服务 服务发现、服务治理、熔断等等
4. docker+k8s 将应用容器化
5. 分布式高可用的中间件消息队列，kafka或者pulsa等以及各类MQ
6. 高可用的非关系数据库集群 Redis 或者 Elasticsearch、Hbase等
7. 分布式高可用的持久化数据库层，TiDB 或者通过ShardingSphere、MyCat等实现的高可用分库分表
8. 数仓 hadoop 或者其他技术栈 以及Flink等处理流式数据 或者spark批处理数据